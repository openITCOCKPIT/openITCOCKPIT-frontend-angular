<ng-container *transloco="let t">
    <nav aria-label="breadcrumb" class="mt-3">
        <ol class="breadcrumb">
            <li class="breadcrumb-item">
                <a [routerLink]="['/']">
                    <fa-icon [icon]="['fas', 'home']"></fa-icon>
                    {{ t('Home') }}
                </a></li>
            <li class="breadcrumb-item">
                <fa-icon [icon]="['fas', 'puzzle-piece']"></fa-icon>
                {{ t('Event Correlation Module') }}
            </li>
            <li class="breadcrumb-item">
                <a *oitcPermission="['EventcorrelationModule', 'eventcorrelations', 'index']"
                   [routerLink]="['/', 'eventcorrelation_module', 'eventcorrelations', 'index']">
                    <fa-icon [icon]="['fas', 'user-secret']"></fa-icon>
                    {{ t('Event Correlations') }}
                </a>
            </li>
            <li aria-current="page" class="breadcrumb-item active">
                <fa-icon [icon]="['fas', 'pen-to-square']"></fa-icon>
                {{ t('Edit correlation') }}
            </li>
        </ol>
    </nav>

    @if (isLoading) {
        <oitc-block-loader [height]="'25rem'"></oitc-block-loader>
    }
    @if (!isLoading) {
        <c-card class="mb-3 d-flex flex-column">
            <c-card-header>
                <h5 cCardTitle>{{ t('Edit Event Correlation:') }}
                    @if (rootElement) {
                        <small class="fw-300">
                            {{ rootElement.host.name }}
                        </small>
                    }
                    @if (hasUnsavedChanges) {
                        <c-badge color="danger" class="ms-3">
                            {{ t('Unsaved changes') }}
                        </c-badge>
                    }


                </h5>

                <c-nav class="card-toolbar card-header-pills">
                    <c-nav-item class="px-1">
                        <button (click)="saveEventcorrelation()" cButton class="ripple" color="success" size="xs">
                            <fa-icon [icon]="['fas', 'floppy-disk']"></fa-icon>
                            {{ t('Save Event Correlation') }}
                        </button>
                    </c-nav-item>
                    <c-nav-item class="px-1">
                        <button [fallbackUrl]="['eventcorrelation_module', 'eventcorrelations', 'index']" cButton
                                class="ripple" color="default"
                                oitcBackButton
                                size="xs">
                            <fa-icon [icon]="['fas', 'left-long']"></fa-icon>
                            {{ t('Back') }}
                        </button>
                    </c-nav-item>
                    @if (id) {
                        <c-nav-item class="px-1">
                            <a *oitcPermission="['EventcorrelationModule', 'eventcorrelations', 'view']"
                               [routerLink]="['/', 'eventcorrelation_module', 'eventcorrelations', 'view', id]"
                               cButton
                               class="ripple"
                               color="primary"
                               size="xs">
                                <fa-icon [icon]="['fas', 'eye']"></fa-icon>
                                {{ t('View') }}
                            </a>
                        </c-nav-item>
                    }
                </c-nav>
            </c-card-header>
            <c-card-body class="d-flex flex-column h-100">
                <c-row>
                    <c-col [xs]="12" [md]="6">
                        <fa-icon [icon]="['fas', 'square']" class="p-0 ok"></fa-icon>
                        <em class="pe-1">
                            {{ t('Ok') }}
                        </em>

                        <fa-icon [icon]="['fas', 'square']" class="p-0 warning"></fa-icon>
                        <em class="pe-1">
                            {{ t('Warning') }}
                        </em>

                        <fa-icon [icon]="['fas', 'square']" class="p-0 critical"></fa-icon>
                        <em class="pe-1">
                            {{ t('Critical') }}
                        </em>

                        <fa-icon [icon]="['fas', 'square']" class="p-0 unknown"></fa-icon>
                        <em class="pe-1">
                            {{ t('Unknown') }}
                        </em>

                        <fa-icon [icon]="['fas', 'square']" class="p-0 text-primary"></fa-icon>
                        <em class="pe-1">
                            {{ t('Not monitored') }}
                        </em>
                    </c-col>
                </c-row>

                <div class="d-flex h-100">
                    <oitc-evc-tree-edit
                        class="flex-1 w-100 h-100 mt-3"
                        [evcId]="id"
                        [evcTree]="evcTree"
                        [stateForDisabledService]="stateForDisabledService"
                        [animated]="animated"
                        [connectionLine]="connectionLine"
                        [evcNodeWithErrorsInput]="evcNodeWithErrors"
                        [layerWithErrorsInput]="layerWithErrors"
                        (toggleVServiceModal)="onToggleVServiceModal($event)"
                        (toggleDeleteEvcNode)="onDeleteEvcNode($event)"
                        [highlightHostId]="highlightHostId"
                        [highlightServiceId]="highlightServiceId"></oitc-evc-tree-edit>
                </div>

            </c-card-body>
            <c-card-footer>
                &nbsp;
            </c-card-footer>
        </c-card>
    }



    <!-- Service / vService modal -->
    <c-modal
        #modal='cModal'
        [keyboard]="true"
        id="evcVServicesModal"
        [size]="'xl'"
    >
        <c-modal-header>
            <h5 cModalTitle>
                <fa-icon [icon]="['fas', 'wrench']"></fa-icon>
                @if (modalVService?.current_evc?.mode === 'add') {
                    {{ t('Create virtual service') }}
                }

                @if (modalVService?.current_evc?.mode === 'edit') {
                    {{ t('Modify virtual service') }}
                }
            </h5>
            <button cButtonClose (click)="hideModal()"></button>
        </c-modal-header>
        @if (modalVService) {
            <c-modal-body>

                <div class="mb-3">
                    <label cLabel for="servicename">
                        {{ t('Name of vService') }}
                        <oitc-required-icon></oitc-required-icon>
                    </label>
                    <input cFormControl type="text"
                           id="servicename"
                           name="servicename"
                           oitcFormError [errors]="errors" errorField="servicename"
                           [(ngModel)]="modalVService.servicename">
                    <oitc-form-feedback [errors]="errors" errorField="servicename"></oitc-form-feedback>
                    <div class="help-block">
                        {{ t('Name of the virtual service that holds the result of the correlation.') }}
                    </div>
                </div>

                <div class="mb-3">
                    <label cLabel for="servicetemplate">
                        {{ t('Service template') }}
                        <oitc-required-icon></oitc-required-icon>
                    </label>

                    <oitc-select
                        name="servicetemplate"
                        id="servicetemplate"
                        optionValue="key"
                        optionLabel="value"
                        [(ngModel)]="modalVService.servicetemplate_id"
                        [options]="servicetemplates"
                        [appendTo]="''"
                        oitcFormError [errors]="errors" errorField="servicetemplate_id">
                    </oitc-select>
                    <oitc-form-feedback [errors]="errors"
                                        errorField="servicetemplate_id"></oitc-form-feedback>
                    <div class="help-block">
                        {{ t('Only service templates of the EVC type are available.') }}
                    </div>
                </div>

                @if (modalCurrentLayerIndex === 0) {
                    <!-- "Real" Services -->
                    <div class="mb-3">
                        <label for="operator" cLabel>
                            {{ t('Services') }}
                            <oitc-required-icon/>
                        </label>
                        <c-input-group>
                            <oitc-multi-select-optgroup
                                name="Services"
                                id="Services"
                                optionValue="value"
                                optionLabel="label"
                                [options]="modalServicesForSelect"
                                [(ngModel)]="modalVService.service_ids"
                                [searchCallback]="loadServicesForModal"
                                class="flex-1"
                                [appendTo]="''"
                                (onChange)="updateServiceScores()"
                                oitcFormError [errors]="errors" errorField="service_ids">
                            </oitc-multi-select-optgroup>
                        </c-input-group>
                        <oitc-form-feedback [errors]="errors" errorField="service_ids"></oitc-form-feedback>
                        <div class="help-block">
                            {{ t('Services that should be correlated') }}
                        </div>
                    </div>
                }

                @if (modalCurrentLayerIndex > 0) {
                    <!-- "virtual" Services -->
                    <div class="mb-3">
                        <label for="operator" cLabel>
                            {{ t('vServices') }}
                            <oitc-required-icon/>
                        </label>
                        <c-input-group>
                            <oitc-multi-select-optgroup
                                name="Services"
                                id="Services"
                                optionValue="value"
                                optionLabel="label"
                                [options]="modalServicesForSelect"
                                [(ngModel)]="modalVService.service_ids"
                                [searchCallback]="loadServicesForModal"
                                class="flex-1"
                                [appendTo]="''"
                                (onChange)="updateServiceScores()"
                                oitcFormError [errors]="errors" errorField="service_ids">
                            </oitc-multi-select-optgroup>
                        </c-input-group>
                        <oitc-form-feedback [errors]="errors" errorField="service_ids"></oitc-form-feedback>
                        <div class="help-block">
                            {{ t('Virtual services that should be correlated') }}
                        </div>
                    </div>
                }

                <div class="mb-3">
                    <label for="operator" cLabel>
                        {{ t('Operator') }}
                        <oitc-required-icon/>
                    </label>
                    <oitc-select
                        name="operator"
                        id="operator"
                        optionValue="key"
                        optionLabel="value"
                        [(ngModel)]="modalVService.operator"
                        [options]="modalOperators"
                        [appendTo]="''"
                        (onChange)="updateServiceScores()"
                        oitcFormError [errors]="errors" errorField="operator">
                    </oitc-select>
                    <oitc-form-feedback [errors]="errors" errorField="operator"></oitc-form-feedback>
                </div>

                @if (modalVService.operator === EventcorrelationOperators.MIN) {
                    <div class="mb-3">
                        <label cLabel for="operator_modifier">
                            {{ t('Operator modifier') }}
                            <oitc-required-icon></oitc-required-icon>
                        </label>
                        <input cFormControl type="number"
                               id="operator_modifier"
                               name="operator_modifier"
                               oitcFormError [errors]="errors" errorField="operator_modifier"
                               [(ngModel)]="modalVService.operator_modifier">
                        <oitc-form-feedback [errors]="errors" errorField="operator_modifier"></oitc-form-feedback>
                    </div>
                }

                @if (modalVService.operator && [EventcorrelationOperators.SCORESCLALARGREATER,
                                                EventcorrelationOperators.SCORESCLALARLESSER,
                                                EventcorrelationOperators.SCORERANGEINCLUSIVE,
                                                EventcorrelationOperators.SCORERANGEEXCLUSIVE].includes(modalVService.operator)) {
                    <fieldset class="mt-10">
                        <legend class="fieldset-legend-border-bottom">
                            <h5>
                                <fa-icon [icon]="['fas', 'cogs']"></fa-icon>
                                {{ t('Score settings') }}
                            </h5>
                        </legend>
                        @if (modalVService.service_ids.length > 0) {
                            <fieldset class="mt-4">
                                <legend class="small m-0">
                                    <h6>
                                        {{ t('Services') }}
                                    </h6>
                                </legend>
                                @if (evcTree[this.modalVService.current_evc.layerIndex - 1] && modalVService.current_evc.evc_node_id) {
                                    @for (service of evcTree[this.modalVService.current_evc.layerIndex - 1][modalVService.current_evc.evc_node_id]; track $index) {
                                        <c-row class="pb-1"
                                               [ngClass]="{odd: $index % 2 === 0, even: $index % 2 !== 0}">
                                            <c-col [xs]="12" [md]="12" [lg]="6">
                                                {{ service.service.host.name }}/{{ service.service.servicename }}
                                            </c-col>
                                            <c-col [xs]="12" [md]="12" [lg]="2">
                                                <c-input-group sizing="sm">
                                                    <span cInputGroupText>
                                                        <fa-icon [icon]="['fas', 'weight-hanging']"
                                                                 [cTextColor]="'warning'"></fa-icon>
                                                    </span>
                                                    <input cFormControl type="number"
                                                           [name]="'score_warning_' + service.id"
                                                           [ngModel]="service.score_warning"
                                                           [placeholder]="'Warning score' | transloco"/>
                                                </c-input-group>
                                            </c-col>
                                            <c-col [xs]="12" [md]="12" [lg]="2">
                                                <c-input-group sizing="sm">
                                                    <span cInputGroupText>
                                                        <fa-icon [icon]="['fas', 'weight-hanging']"
                                                                 [cTextColor]="'danger'"></fa-icon>
                                                    </span>
                                                    <input cFormControl type="number"
                                                           [name]="'score_critical_' + service.id"
                                                           [ngModel]="service.score_critical"
                                                           [placeholder]="'Critical score' | transloco"/>
                                                </c-input-group>
                                            </c-col>
                                            <c-col [xs]="12" [md]="12" [lg]="2">
                                                <c-input-group sizing="sm">
                                                    <span cInputGroupText>
                                                        <fa-icon [icon]="['fas', 'weight-hanging']"
                                                                 [cTextColor]="'secondary'"></fa-icon>
                                                    </span>
                                                    <input cFormControl type="number"
                                                           [name]="'score_unknown_' + service.id"
                                                           [ngModel]="service.score_unknown"
                                                           [placeholder]="'Unknown score' | transloco"/>
                                                </c-input-group>
                                            </c-col>
                                        </c-row>
                                    }
                                }
                            </fieldset>
                        }
                        <fieldset class="mt-2">
                            <legend class="small m-0">
                                <h6 class="text-warning">
                                    <fa-icon [icon]="['fas', 'exclamation-triangle']"
                                             [cTextColor]="'warning'"></fa-icon>
                                    {{ t('Score for warning') }}
                                </h6>
                            </legend>
                            <c-row>
                                <c-col>
                                    <div>
                                        <label cLabel for="ValidateService.warning_min">
                                            {{ t('Warning') }}
                                            @if (modalVService.operator === EventcorrelationOperators.SCORERANGEINCLUSIVE ||
                                            modalVService.operator === EventcorrelationOperators.SCORERANGEEXCLUSIVE) {
                                                <span>
                                                    {{ t('min') }}
                                                </span>
                                            }
                                            <oitc-required-icon/>
                                        </label>
                                        <input cFormControl
                                               id="ValidateService.warning_min"
                                               type="number"
                                               name="ValidateService.warning_min"
                                               [(ngModel)]="modalVService.operator_warning_min"
                                               oitcFormError [errors]="errors" errorField="operator_warning_min">
                                        <oitc-form-feedback [errors]="errors"
                                                            errorField="operator_warning_min"></oitc-form-feedback>
                                    </div>
                                </c-col>
                                @if (modalVService.operator === EventcorrelationOperators.SCORERANGEINCLUSIVE ||
                                modalVService.operator === EventcorrelationOperators.SCORERANGEEXCLUSIVE) {
                                    <c-col [xs]="5">
                                        <div>
                                            <label cLabel for="ValidateService.warning_max">
                                                {{ t('Warning max') }}
                                                <oitc-required-icon/>
                                            </label>
                                            <input cFormControl
                                                   id="ValidateService.warning_max"
                                                   type="number"
                                                   name="ValidateService.warning_max"
                                                   [(ngModel)]="modalVService.operator_warning_max"
                                                   oitcFormError [errors]="errors" errorField="operator_warning_max">
                                            <oitc-form-feedback [errors]="errors"
                                                                errorField="operator_warning_max"></oitc-form-feedback>
                                        </div>
                                    </c-col>
                                    <c-col xs="2">
                                        <oitc-score-thresholds
                                            [inclusive]="(modalVService.operator === EventcorrelationOperators.SCORERANGEINCLUSIVE)"
                                            [min]="modalVService.operator_warning_min"
                                            [max]="modalVService.operator_warning_max"
                                            [type]="'warning'">
                                        </oitc-score-thresholds>
                                    </c-col>
                                }
                            </c-row>
                        </fieldset>
                        <fieldset class="mt-2">
                            <legend class="small m-0">
                                <h6 class="text-danger">
                                    <fa-icon [icon]="['fas', 'exclamation-triangle']" [cTextColor]="'danger'"></fa-icon>
                                    {{ t('Score for critical') }}
                                </h6>
                            </legend>
                            <c-row>
                                <c-col>
                                    <div>
                                        <label cLabel for="ValidateService.critical_min">
                                            {{ t('Critical') }}
                                            @if (modalVService.operator === EventcorrelationOperators.SCORERANGEINCLUSIVE ||
                                            modalVService.operator === EventcorrelationOperators.SCORERANGEEXCLUSIVE) {
                                                <span>
                                                    {{ t('min') }}
                                                </span>
                                            }
                                            <oitc-required-icon/>
                                        </label>
                                        <input cFormControl
                                               id="ValidateService.critical_min"
                                               type="number"
                                               name="ValidateService.critical_min"
                                               [(ngModel)]="modalVService.operator_critical_min"
                                               oitcFormError [errors]="errors" errorField="operator_critical_min">
                                        <oitc-form-feedback [errors]="errors"
                                                            errorField="operator_critical_min"></oitc-form-feedback>
                                    </div>
                                </c-col>
                                @if (modalVService.operator === EventcorrelationOperators.SCORERANGEINCLUSIVE ||
                                modalVService.operator === EventcorrelationOperators.SCORERANGEEXCLUSIVE) {
                                    <c-col [xs]="5">
                                        <div>
                                            <label cLabel for="ValidateService.critical_max">
                                                {{ t('Critical max') }}
                                                <oitc-required-icon/>
                                            </label>
                                            <input cFormControl
                                                   id="ValidateService.critical_max"
                                                   type="number"
                                                   name="ValidateService.critical_max"
                                                   [(ngModel)]="modalVService.operator_critical_max"
                                                   oitcFormError [errors]="errors" errorField="operator_critical_max">
                                            <oitc-form-feedback [errors]="errors"
                                                                errorField="operator_critical_max"></oitc-form-feedback>
                                        </div>
                                    </c-col>
                                    <c-col xs="2">
                                        <oitc-score-thresholds
                                            [inclusive]="(modalVService.operator === EventcorrelationOperators.SCORERANGEINCLUSIVE)"
                                            [min]="modalVService.operator_critical_min"
                                            [max]="modalVService.operator_critical_max"
                                            [type]="'critical'">
                                        </oitc-score-thresholds>
                                    </c-col>
                                }
                            </c-row>
                        </fieldset>
                        <fieldset class="mt-2">
                            <legend class="small m-0">
                                <h6 class="text-secondary">
                                    <fa-icon [icon]="['fas', 'circle-question']" [cTextColor]="'secondary'"></fa-icon>
                                    {{ t('Score for unknown') }}
                                </h6>
                            </legend>
                            <c-row>
                                <c-col>
                                    <div>
                                        <label cLabel for="ValidateService.unknown_min">
                                            {{ t('Unknown') }}
                                            @if (modalVService.operator === EventcorrelationOperators.SCORERANGEINCLUSIVE ||
                                            modalVService.operator === EventcorrelationOperators.SCORERANGEEXCLUSIVE) {
                                                <span>
                                                    {{ t('min') }}
                                                </span>
                                            }
                                            <oitc-required-icon/>
                                        </label>
                                        <input cFormControl
                                               id="ValidateService.unknown_min"
                                               type="number"
                                               name="ValidateService.unknown_min"
                                               [(ngModel)]="modalVService.operator_unknown_min"
                                               oitcFormError [errors]="errors" errorField="operator_unknown_min">
                                        <oitc-form-feedback [errors]="errors"
                                                            errorField="operator_unknown_min"></oitc-form-feedback>
                                    </div>
                                </c-col>
                                @if (modalVService.operator === EventcorrelationOperators.SCORERANGEINCLUSIVE ||
                                modalVService.operator === EventcorrelationOperators.SCORERANGEEXCLUSIVE) {
                                    <c-col xs="5">
                                        <div>
                                            <label cLabel for="ValidateService.unknown_max">
                                                {{ t('Unknown max') }}
                                                <oitc-required-icon/>
                                            </label>
                                            <input cFormControl
                                                   id="ValidateService.unknown_max"
                                                   type="number"
                                                   name="ValidateService.unknown_max"
                                                   [(ngModel)]="modalVService.operator_unknown_max"
                                                   oitcFormError [errors]="errors" errorField="operator_unknown_max">
                                            <oitc-form-feedback [errors]="errors"
                                                                errorField="operator_unknown_max"></oitc-form-feedback>
                                        </div>
                                    </c-col>
                                    <c-col xs="2">
                                        <oitc-score-thresholds
                                            [inclusive]="(modalVService.operator === EventcorrelationOperators.SCORERANGEINCLUSIVE)"
                                            [min]="modalVService.operator_unknown_min"
                                            [max]="modalVService.operator_unknown_max"
                                            [type]="'unknown'">
                                        </oitc-score-thresholds>
                                    </c-col>
                                }
                            </c-row>
                        </fieldset>
                    </fieldset>
                }
            </c-modal-body>
        }
        <c-modal-footer>
            <button cButton class="ripple" color="primary"
                    (click)="validateModalForm()"
                    [disabled]="showSpinner">
                @if (showSpinner) {
                    <fa-icon [icon]="['fas', 'spinner']" [animation]="'spin'"></fa-icon>
                }
                {{ t('Save') }}
            </button>
            <button (click)="hideModal()" cButton class="ripple" color="default">
                {{ t('Cancel') }}
            </button>
        </c-modal-footer>
    </c-modal>

</ng-container>
