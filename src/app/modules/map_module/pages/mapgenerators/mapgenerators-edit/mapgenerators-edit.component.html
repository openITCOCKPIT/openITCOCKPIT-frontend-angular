<ng-container *transloco="let t">
    <nav aria-label="breadcrumb" class="mt-3">
        <ol class="breadcrumb">
            <li class="breadcrumb-item">
                <a [routerLink]="['/']">
                    <fa-icon [icon]="['fas', 'home']"></fa-icon>
                    {{ t('Home') }}
                </a></li>
            <li class="breadcrumb-item">
                <fa-icon [icon]="['fas', 'puzzle-piece']"></fa-icon>
                {{ t('Map Module') }}
            </li>
            <li class="breadcrumb-item">
                <a *oitcPermission="['mapmodule', 'mapgenerators', 'index']"
                   [routerLink]="['/', 'map_module', 'mapgenerators', 'index']">
                    <fa-icon [icon]="['fas', 'cog']"></fa-icon>
                    {{ t('Map generators') }}
                </a>
            </li>
            <li aria-current="page" class="breadcrumb-item active">
                <fa-icon [icon]="['fas', 'edit']"></fa-icon>
                {{ t('Edit') }}
            </li>
        </ol>
    </nav>

    <oitc-form-loader [isVisible]="!post"></oitc-form-loader>

    @if (post) {
        <form cForm (ngSubmit)="updateMapgenerator()">
            <c-card class="mb-3">
                <c-card-header>
                    <h5 cCardTitle>
                        {{ t('Edit map generator') }}

                        <small class="fw-300">
                            {{ post.Mapgenerator.name }}
                        </small>
                    </h5>

                    <c-nav class="card-toolbar card-header-pills">
                        <c-nav-item class="px-1">
                            <button [fallbackUrl]="['map_module', 'mapgenerators', 'index']" cButton class="ripple"
                                    color="default"
                                    oitcBackButton
                                    size="xs">
                                <fa-icon [icon]="['fas', 'left-long']"></fa-icon>
                                {{ t('Back') }}
                            </button>
                        </c-nav-item>
                    </c-nav>

                </c-card-header>
                <c-card-body>

                    <div class="mb-3">
                        <label cLabel for="mapgenerator_type">
                            {{ t('Generate By') }}
                            <oitc-required-icon></oitc-required-icon>
                        </label>

                        <oitc-select
                            name="mapgenerator_type"
                            id="mapgenerator_type"
                            optionValue="key"
                            optionLabel="value"
                            [(ngModel)]="post.Mapgenerator.type"
                            [options]="types"
                            oitcFormError [errors]="errors" errorField="type">
                        </oitc-select>
                        <oitc-form-feedback [errors]="errors" errorField="type"></oitc-form-feedback>
                    </div>

                    <div class="mb-3">
                        <label cLabel for="mapgenerator_container">
                            {{ t('Container') }}
                            <oitc-required-icon></oitc-required-icon>
                        </label>

                        <oitc-multi-select
                            name="mapgenerator_container"
                            id="mapgenerator_container"
                            optionValue="key"
                            optionLabel="value"
                            [(ngModel)]="post.Mapgenerator.containers._ids"
                            [options]="containers"
                            [debounce]="true"
                            oitcFormError [errors]="errors" errorField="containers">
                        </oitc-multi-select>

                        @if (post.Mapgenerator.containers._ids.length === 0) {
                            <div class="text-warning-glow pt-1">
                                {{ t('Please select a container.') }}
                            </div>
                        }
                        <oitc-form-feedback [errors]="errors" errorField="containers"></oitc-form-feedback>
                        @if (this.post.Mapgenerator.type === MapgeneratorTypes.GENERATE_BY_CONTAINER_STRUCTURE) {
                            <div class="col-12 help-block text-info">
                                <fa-icon [icon]="['fas', 'info-circle']"></fa-icon>
                                {{ t('The specified containers must appear in the container hierarchy of the host so that the host is taken into account during generation.') }}
                            </div>
                        }
                        @if (this.post.Mapgenerator.type === MapgeneratorTypes.GENERATE_BY_HOSTNAME_SPLITTING) {
                            <div class="col-12 help-block text-info">
                                <fa-icon [icon]="['fas', 'info-circle']"></fa-icon>
                                {{ t('The specified containers must appear in the container level (specified below) of the host name so that the host is taken into account during generation.') }}
                            </div>
                        }
                    </div>

                    <div class="mb-3">
                        <label cLabel for="mapgenerator_name">
                            {{ t('Name') }}
                            <oitc-required-icon></oitc-required-icon>
                        </label>
                        <input cFormControl
                               id="mapgenerator_name"
                               required
                               type="text"
                               name="mapgenerator_name"
                               oitcFormError [errors]="errors" errorField="name"
                               [(ngModel)]="post.Mapgenerator.name">
                        <oitc-form-feedback [errors]="errors" errorField="name"></oitc-form-feedback>
                    </div>

                    <div class="mb-3">
                        <label cLabel for="description">
                            {{ t('Description') }}
                        </label>
                        <input cFormControl
                               id="mapgenerator_description"
                               type="text"
                               name="mapgenerator_description"
                               oitcFormError [errors]="errors" errorField="description"
                               [(ngModel)]="post.Mapgenerator.description">
                        <oitc-form-feedback [errors]="errors" errorField="description"></oitc-form-feedback>
                    </div>

                    <div class="mt-4">
                        <h5>
                            {{ t('Generator Configuration:') }}
                        </h5>
                    </div>
                    <hr class="border-dashed">

                    <div class="mb-3">
                        <label cLabel for="mapgenerator_interval">
                            {{ t('Map refresh interval') }}
                            <oitc-required-icon></oitc-required-icon>
                        </label>
                        <input cFormControl
                               id="mapgenerator_interval"
                               type="number"
                               name="mapgenerator_interval"
                               min="5"
                               max="180"
                               [(ngModel)]="post.Mapgenerator.map_refresh_interval"
                               oitcFormError [errors]="errors" errorField="map_refresh_interval">
                        <oitc-form-feedback [errors]="errors" errorField="map_refresh_interval"></oitc-form-feedback>
                    </div>

                    <div class="mb-3">
                        <label cLabel for="mapgenerator_items_per_line">
                            {{ t('Items per line') }}
                            <oitc-required-icon></oitc-required-icon>
                        </label>
                        <input cFormControl
                               id="mapgenerator_items_per_line"
                               type="number"
                               name="mapgenerator_items_per_line"
                               min="5"
                               [(ngModel)]="post.Mapgenerator.items_per_line"
                               oitcFormError [errors]="errors" errorField="items_per_line">
                        <oitc-form-feedback [errors]="errors" errorField="items_per_line"></oitc-form-feedback>
                    </div>

                    @if (this.post.Mapgenerator.type === MapgeneratorTypes.GENERATE_BY_HOSTNAME_SPLITTING) {

                        <div class="mt-4">
                            <h5>
                                {{ t('Levels:') }}
                                <oitc-required-icon></oitc-required-icon>
                            </h5>
                            <oitc-form-feedback [errors]="errors" errorField="mapgenerator_levels"></oitc-form-feedback>
                            <div class="col-12 help-block text-info">
                                <fa-icon [icon]="['fas', 'info-circle']"></fa-icon>
                                {{ t('The host name is split with the dividers and a map is created for each part. The last level specifies the host to be added and must also exist and the number of levels must match the number of parts so that the host can be taken into account during generation. The name is only used as a description in the form.') }}
                            </div>
                        </div>
                        <hr class="border-dashed">

                        @for (level of mapgenerator.levels; track level.id; let i = $index, last = $last) {
                            <div class="row mb-2">
                                <div class="mb-3 col-lg-4">
                                    <c-input-group>
                                        <span cInputGroupText>
                                            <fa-icon [icon]="['fas', 'fingerprint']"></fa-icon>
                                        </span>
                                        <input cFormControl
                                               id="level_name_{{i}}"
                                               name="level_name_{{i}}"
                                               required
                                               type="text"
                                               [placeholder]="getLevelPlaceholder(i, last)"
                                               [ngClass]="{'border-color-error': getMapgeneratorLevelErrors(level.index, 'validate_levels','name').length > 0 || getMapgeneratorLevelErrors(level.index,  'mapgenerator_levels','name').length > 0}"
                                               [(ngModel)]="level.name">
                                    </c-input-group>
                                    @for (
                                        error of getMapgeneratorLevelErrors(level.index, 'mapgenerator_levels', 'name'); track error) {
                                        <div>
                                            <div class="help-block text-danger font-xs">{{ error }}</div>
                                        </div>
                                    }
                                    @for (
                                        error of getMapgeneratorLevelErrors(level.index, 'validate_levels', 'name'); track error) {
                                        <div>
                                            <div class="help-block text-danger font-xs">{{ error }}</div>
                                        </div>
                                    }
                                </div>

                                <div class="mb-3 col-lg-3">
                                    <c-input-group>
                                        <span cInputGroupText>
                                            <fa-icon [icon]="['fas', 'scissors']"></fa-icon>
                                        </span>
                                        <input cFormControl
                                               id="level_divider_{{i}}"
                                               name="level_divider_{{i}}"
                                               required
                                               type="text"
                                               size="5"
                                               maxlength="5"
                                               [disabled]="last"
                                               [placeholder]="dividerPlaceholder"
                                               [ngClass]="{'border-color-error': getMapgeneratorLevelErrors(level.index, 'validate_levels','divider').length > 0 || getMapgeneratorLevelErrors(level.index, 'mapgenerator_levels','divider').length > 0}"
                                               [(ngModel)]="level.divider">
                                    </c-input-group>
                                    @for (
                                        error of getMapgeneratorLevelErrors(level.index, 'mapgenerator_levels', 'divider'); track error) {
                                        <div>
                                            <div class="help-block text-danger font-xs">{{ error }}</div>
                                        </div>
                                    }
                                    @for (
                                        error of getMapgeneratorLevelErrors(level.index, 'validate_levels', 'divider'); track error) {
                                        <div>
                                            <div class="help-block text-danger font-xs">{{ error }}</div>
                                        </div>
                                    }
                                </div>

                                @if (mapgenerator.levels.length > 2) {
                                    <div class="col-lg-1">
                                        <a class="btn btn-danger ripple waves-effect waves-themed"
                                           href="javascript:void(0);"
                                           (click)="removeLevel(level.index)">
                                            <fa-icon [icon]="['fas', 'trash']" size="lg"></fa-icon>
                                        </a>
                                    </div>
                                }
                            </div>
                        }

                        <div class="row mt-3">
                            <div class="col-12 col-md-12 text-end">
                                <button cButton class="ripple" color="success" size="xs" type="button"
                                        (click)="addLevel()">
                                    <fa-icon [icon]="['fas', 'plus']"></fa-icon>
                                    {{ t('Add Level') }}
                                </button>
                            </div>
                        </div>

                        <hr class="border-dashed">

                        <div class="mb-3">
                            <label cLabel for="mapgenerator_level_is_container">
                                {{ t('Container Level') }}
                                <oitc-required-icon></oitc-required-icon>
                            </label>

                            @for (level of mapgenerator.levels; track level.id; let i = $index, last = $last) {
                                <c-form-check>
                                    <input cFormCheckInput type="radio" [value]="mapgenerator.levels[i].index"
                                           id="mapgenerator_level_is_container_{{i}}"
                                           [(ngModel)]="mapgeneratorLevelIsContainerIndex"
                                           name="mapgenerator_level_is_container"/>
                                    <label cFormCheckLabel for="mapgenerator_level_is_container_{{i}}">
                                        @if (level.name !== "") {
                                            {{ level.name }}
                                        } @else {
                                            <span class="text-gray-500">
                                                {{ getLevelPlaceholder(i, last) }}
                                            </span>
                                        }
                                    </label>
                                </c-form-check>
                            }
                            <oitc-form-feedback [errors]="errors"
                                                errorField="validate_levels_is_container"></oitc-form-feedback>
                            <div class="col-12 help-block text-info">
                                <fa-icon [icon]="['fas', 'info-circle']"></fa-icon>
                                {{ t('The specified level must correspond to a container to which you also have rights so that the host is taken into account.') }}
                            </div>
                        </div>

                    }

                </c-card-body>
                <c-card-footer class="text-end">
                    <button cButton class="ripple" color="primary" type="submit">
                        {{ t('Update map generator') }}
                    </button>
                    <button [fallbackUrl]="['map_module', 'mapgenerators', 'index']" cButton class="ms-1 ripple"
                            color="default"
                            oitcBackButton
                            type="button">
                        {{ t('Cancel') }}
                    </button>
                </c-card-footer>
            </c-card>
        </form>
    }
</ng-container>
